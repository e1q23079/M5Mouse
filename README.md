# M5ジャイロマウス

M5Stick-Cの内蔵IMUセンサー（加速度計とジャイロスコープ）を使用して、デバイスの傾きや回転を検出し、BLE（Bluetooth Low Energy）でパソコンやタブレットにマウスコマンドを送信するプログラムです。

## 機能

- **ジャイロマウス機能**: デバイスを傾けることで、マウスカーソルを操作
- **マウスクリック機能**: ボタンA/Bで左クリック・右クリック、長押しでドラッグ
- **スクロールモード**: 電源ボタンでスクロールモードに切り替え
- **2つの動作モード**: マウスモードとスクロールモードを切り替えて使用
- **BLE接続表示**: ディスプレイに接続状態を表示

## 必要な環境

- **ハードウェア**:
  - M5Stick-C（IMUセンサー搭載）
  - Bluetooth対応のPC/タブレット

- **ソフトウェア**:
  - PlatformIO
  - 必要なライブラリ（自動でインストール）:
    - M5Unified
    - ESP32 BLE Mouse
    - Madgwick AHRS

## 使い方

### 1. ビルドと書き込み

```bash
# ビルド
platformio run

# デバイスに書き込み
platformio run --target upload
```

### 2. Bluetoothペアリング

1. **デバイスの電源を入れます**
   - **重要**: 起動直後は、デバイスを水平な場所に置いてください
   - 「Initializing...」の表示が消えるまで動かさないでください（約1秒）
   - この間にIMUセンサーの初期化が行われます
2. PCまたはタブレットのBluetooth設定を開きます
3. 「M5Mouse」を探してペアリングします
4. ディスプレイに「Connected」と表示されたら成功です

### 3. デバイスの向き

M5Stick-Cは以下の向きで使用してください：

- **ボタン側（Type-Cの充電ポート）を手前（前）に向ける**
- ディスプレイが自分に向いている状態
- この向きを基準に、左右の方向に向けるとカーソルが左右に動き、上下の方向に向けるとカーソルが上下に動きます

正しい向きで使用しないと、マウスの動きが期待と異なるため、必ずこの向きで操作してください。

### 4. 操作方法

デバイスには**マウスモード**と**スクロールモード**の2つの動作モードがあります。起動時はマウスモードです。

#### マウスモード（初期状態）

| 操作 | 機能 |
| ------ | ------ |
| デバイスを傾ける | マウスカーソルを移動 |
| ボタンA（中央）押す | 左クリック |
| ボタンA（中央）長押し | 左ボタンを押したままドラッグ |
| ボタンB（左）押す | 右クリック |
| ボタンB（左）長押し | 右ボタンを押したままドラッグ |
| 電源ボタン（右） | スクロールモードに切り替え |

#### スクロールモード

| 操作 | 機能 |
| ------ | ------ |
| ボタンA（中央） | ホイールスクロール下 |
| ボタンB（左） | ホイールスクロール上 |
| 電源ボタン（右） | マウスモードに切り替え |

**注意**: スクロールモードでは、デバイスを傾けてもマウスカーソルは動きません。

### 5. マウス移動の感度調整

マウスカーソルの移動量は`src/main.cpp`の先頭で定義されている`#define`マクロで調整できます：

```cpp
#define MOUSE_SENSITIVITY_X 5.0  // （左右移動）感度
#define MOUSE_SENSITIVITY_Y 3.0  // （上下移動）感度
```

**感度調整のポイント：**

- **MOUSE_SENSITIVITY_X（左右の感度）**: 現在は5.0に設定
  - 数値を大きくする（例：6.0, 7.0）→ 左右の動きが大きくなる（敏感）
  - 数値を小さくする（例：3.0, 2.0）→ 左右の動きが小さくなる（鈍い）

- **MOUSE_SENSITIVITY_Y（上下の感度）**: 現在は3.0に設定
  - 数値を大きくする（例：4.0, 5.0）→ 上下の動きが大きくなる（敏感）
  - 数値を小さくする（例：2.0, 1.0）→ 上下の動きが小さくなる（鈍い）

**調整方法：**

1. `src/main.cpp`をテキストエディタで開く
2. 先頭の`#define`の値を変更して保存
3. `platformio run --target upload`でデバイスに書き込み
4. 実際に操作して感度を確認
5. 好みに合わせて微調整を繰り返す

マウスの使い方によって最適な感度は異なるため、自分に合わせて調整してください。

## トラブルシューティング

### Bluetoothが接続できない場合

- デバイスを再起動してください
- PCのBluetoothを一度OFF/ONにしてください
- ペアリング情報をリセットして再度ペアリングしてください

### マウスが動きすぎる/動きが少ない場合

- `main.cpp`の感度パラメータを調整してください

### デバイスのディスプレイに何も表示されない場合

- コードが正しく書き込まれているか確認してください
- 別のビルド設定を試してください

## 技術仕様

- **センサー**: 6軸IMU（加速度計 + ジャイロスコープ）
- **センサーフュージョン**: Madgwickアルゴリズム
- **サンプリング周波数**: 100Hz
- **通信方式**: Bluetooth Low Energy（BLE）
